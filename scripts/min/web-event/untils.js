define(function(e,t){var n=e("jquery"),r=e("api-config"),i=e("./openapi"),s=e("./attention"),o=e("./../web-ui/dialog"),u=e("./../web-ui/webui"),a=t;e("validate")(n);var f=function(e){return e.replace(/[^\x00-\xff]/g,"**").length},l=function(){n.validator.addMethod("underscore",function(e,t,n){var r=/^(?!_)([\u4e00-\u9fa5]|\w){2,16}$/;return!r.test(e)||e.substring(e.length-1)==="_"?!1:!0}),n.validator.addMethod("charlength",function(e,t){return f(e)>16||f(e)<4?!1:!0}),n.validator.addMethod("regex",function(e,t,n){var r=new RegExp(n);return this.optional(t)||r.test(e)}),n.validator.addMethod("allDigit",function(e,t){var n=/^\d+$/;return this.optional(t)||!n.test(e)})},c=function(){var e,t,i;r.data.couponPeople.html(r.data.backData.CouponInfo.ObtainCount),r.data.backData.CouponInfo.IsObtainEnable||(e=r.dom.finishBtn,e?(t=r.data.dom.find(".btn"),t.off().removeClass("obtain-btn"),t.each(function(){i=n(this),i.hasClass("btnbtm-get")?i.removeClass("btnbtm-get").addClass("btnbtm-over"):i.addClass(e)}),r.data.dom.data("data-original").type==="coupon"&&t.text("已领完")):(r.data.dom.addClass("expired"),r.data.currentBtn.off().removeClass("btn cpbtn-free"),r.data.dom.data("data-original").type==="coupon"&&r.data.currentBtn.text("已领完")))},h=function(){var e=r.data.dialog;n(".btn-login",e).bind("click",function(t){var r=n("input[name='UserAccount']",e);r.val()=="会员名/手机号码"&&r.val("")}),n("input[name='UserAccount']",e).val("会员名/手机号码").addClass("gray"),n("input[name='UserAccount']",e).focus(function(){n(this).val()=="会员名/手机号码"&&n(this).val("").removeClass("gray")}),n("input[name='UserAccount']",e).blur(function(){n(this).val()==""&&n(this).val("会员名/手机号码").addClass("gray").removeClass("error")}),n("ul.open-login",e).click(i.openAPILogin),n(".close-btn",e).click(function(e){n.pdw.dialog.close()}),n(".popup-box").addClass("popup-body");var t=n("form",e),o=n("#errorMsg",e);n(".error-login",e).hide(),t.validate({debug:!0,errorPlacement:function(t,n){t.addClass("red field-foot error-login lh1").insertAfter(n.closest("span"),e),t.closest("div").addClass("field-error")},onkeyup:function(){},errorElement:"span",rules:{UserAccount:{required:!0,underscore:!0,charlength:!0},UserPwd:{required:!0,rangelength:[6,16],regex:"^([\\w]|[\\-]){6,16}$"}},messages:{UserAccount:{required:"请输入账号",underscore:"输入的账号格式不正确",charlength:"账号为4至16位,一个汉字为两个字符"},UserPwd:{required:"请输入密码",rangelength:"密码长度在6至16位",regex:"输入的密码格式不正确"}},submitHandler:function(){var e=n("input[name='DefaultLogin']"),i;e.is(":checked")?e.val("1"):e.val("0"),n.ajax({url:r.api.doLoginUrl,data:t.serialize(),success:function(e){var t=parseInt(e.status),i;t===1&&(n.pdw.dialog.close(),i=r.data.postData,i?(r.data.postData=undefined,s.fAttention(i,"reload")):n("#pdw_head_user")[0]!=="undefined"&&u.fHeadHtml(e.data))},error:function(e,t,r){var i=e.responseText;try{i=n.parseJSON(e.responseText),parseInt(i.status)!=1&&o.text(i.data).show(function(){setTimeout(function(){o.slideUp()},5e3)})}catch(s){o.text("登录发生错误，请重试。").show()}}})}})},p=function(){var e=r.data.dialog,t=/^(?!_)([\u4e00-\u9fa5]|\w){2,16}$/,o=/^\d+$/i,a=/^[\w]{6,16}$/i;n("ul.open-login",e).click(i.openAPILogin),n("#pdw-user-login").click(function(e){e.preventDefault(),y()});var t=/^(?!_)([\u4e00-\u9fa5]|\w){2,16}$/,o=/^\d+$/i,a=/^[\w]{6,16}$/i;n("#regUsername",e).bind("blur",function(){var r=n("#regUsername",e).val(),i=n("#errorAccount",e),s;if(r=="")return i.hide(),!1;if(o.test(r))return i.hide(),!1;if(!t.test(r))return i.hide(),!1;if(r.substring(r.length-1)=="_")return i.hide(),!1;if(f(r)>16||f(r)<4)return i.hide(),!1;i.hide(),n.ajax({type:"post",dataType:"json",url:"/User/CheckAccountIsExists",data:{UserAccount:r},success:function(t){t.status==1?(i.text("").addClass("valid").show(),n("#isExists",e).val("1")):(i.text("会员名已被注册").removeClass("valid").show(),n("#isExists",e).val(""))}})}),veriCodeImg=n("#veri_code").attr("src"),n("#change_code").click(function(e){e.preventDefault(),n("#veri_code").attr("src",veriCodeImg+"?timestamp="+(new Date).getTime())}),n("#signupForm",e).validate({success:function(e){e.is(function(){n(this).attr("for")=="regUsername"||n(this).attr("for")=="ValidateCode"||n(this).attr("for")=="IsRead"?n(this).hide().remove():e.addClass("valid")})},errorPlacement:function(e,t){(t.is(":radio")||t.is(":checkbox"))&&e.removeClass("valid").insertAfter(t.parent()),t.is("input[name='ValidateCode']")?e.removeClass("valid").addClass("red field-foot error-login db lh1").appendTo(t.closest(".field-span")):e.removeClass("valid").addClass("red field-foot error-login db lh1").insertAfter(t.closest("span"))},onkeyup:function(){},errorElement:"span",ignore:"",rules:{UserAccount:{required:!0,charlength:!0,underscore:!0,allDigit:!0},UserPwd:{required:!0,rangelength:[6,16],regex:"^[\\w]{6,16}$"},ConfirmPwd:{required:!0,rangelength:[6,16],equalTo:"#password"},ValidateCode:{required:!0},IsRead:{required:!0},isExists:{required:!0}},messages:{UserAccount:{required:"请输入会员名",charlength:"会员名长度在4至16位,一个汉字为两个字符",underscore:"会员名格式不正确",allDigit:"会员名不能全为数字"},UserPwd:{required:"请输入密码",rangelength:"密码长度在6至16位",regex:"输入的密码格式不正确"},ConfirmPwd:{required:"请输入确认密码",rangelength:"密码长度在6至16位",equalTo:"两次密码不一致"},ValidateCode:{required:"请输入验证码"},IsRead:{required:"请选择同意注册条款"},isExists:{required:"会员名已存在"}},submitHandler:function(){var e=n("input[name='IsRead']"),t=n("input[name='UserAccount']").val();e.is(":checked")?e.val("1"):e.val("0"),n.ajax({type:"post",url:"/User/DoRegister",global:!1,cache:!1,dataType:"json",data:{UserAccount:t,UserPwd:n("input[name='UserPwd']").val(),ConfirmPwd:n("input[name='ConfirmPwd']").val(),ValidateCode:n("input[name='ValidateCode']").val(),IsRead:n("input[name='IsRead']").val()},beforeSend:function(e){e.setRequestHeader("ajax","true")},error:function(e,t,r){var i=n.parseJSON(e.responseText);i.status!=1&&(n("#msg").text(i.data).show(function(){setTimeout(function(){n("#msg").slideUp()},5e3)}),n("#change_code").click(),n("input[name='UserPwd']").val(""),n("input[name='ConfirmPwd']").val(""),n("input[name='ValidateCode']").val(""))},success:function(e){var i=parseInt(e.status,10);if(i===1){var o=r.data.postData;o?(r.data.postData=undefined,s.fAttention(o,"reload")):u.fHeadHtml(t)}else n("#msg").text(e.data).show(),n("#change_code").click()}})}})},d=function(e){var t=r.api.isLogin,i;return n.ajax({url:t,async:!1,success:function(e){parseInt(e.status)===1?i=!0:i=!1},error:function(t,n,r){i=!1;if(e)return myError.fInitError(t),!1}}),i},v=function(){var e,t=r.api.getMobile;return n.ajax({url:t,async:!1,success:function(t){parseInt(t.status)===1&&(e=t.data.UserMobileInfo)},error:function(e){return myError.fInitError(e),!1}}),e},m=function(e){var t,i,s;return PDW.requestShops&&(PDW.requestShops.abort(),PDW.requestShops=undefined),PDW.requestShops=n.ajax({data:e,async:!1,url:r.api.getShopsUrl,success:function(e){parseInt(e.status)===1&&(s=e.data)},error:function(e){return myError.fInitError(e),!1}}),s},g=function(){obxes=n("div."+r.dom.boxes),obox=n("div."+r.dom.box),typeof obxes[0]!="undefined"&&(r.data.districtId=n(r.dom.main).attr("district_id"),fInstData(obxes),typeof obox[0]!="undefined"&&obox.find(".btn").not(".btn-disabled").off("click").bind("click",function(e){me=n(this),r.data.currentBtn=me,self=me.closest("."+r.dom.box),r.data.dom=self,boxData=self.data("data-original"),boxData&&(r.data.boxData=boxData,e.preventDefault(),n.ajax({url:r.api.IsObtainUrl,data:{id:boxData.sid},success:function(e){parseInt(e.status)===1?coupon.fGetCoupon():y()},error:function(e){myError.fInitError(e,"valid")}}))}))},y=function(){o.fLoginHtml()},b=function(){o.fRegisterHtml()};l(),a.fGetShops=m,a.fInstLogin=y,a.fGetMobile=v,a.isLogin=d,a.fLoginEvent=h,a.fRegister=b,a.fRegisterEvent=p,a.fRresetCoupon=c});